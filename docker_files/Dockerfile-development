FROM python:3.6.1

RUN mkdir -p /usr/src/app
WORKDIR /usr/src/app

ADD ./requirements/development.txt /usr/src/app/requirements/development.txt
ADD ./app /usr/src/app/app
ADD ./src /usr/src/app/src
ADD manage.py /usr/src/app/manage.py

RUN pip install -r requirements/development.txt

ARG ALLOWED_HOST
ENV ALLOWED_HOST $ALLOWED_HOST

ENV USERS_DB_NAME ${USERS_DB_NAME}
ENV USERS_DB_PASSWORD $USERS_DB_PASSWORD
ENV USERS_DB_USER $USERS_DB_USER
ENV USERS_DB_HOST $USERS_DB_HOST
ENV USERS_DB_PORT $USERS_DB_PORT
ENV USERS_DB_PORT_EXT $USERS_DB_PORT_EXT

ENV PROJECTS_DB_NAME $PROJECTS_DB_NAME
ENV PROJECTS_DB_PASSWORD $PROJECTS_DB_PASSWORD
ENV PROJECTS_DB_USER $PROJECTS_DB_USER
ENV PROJECTS_DB_PORT $PROJECTS_DB_PORT
ENV PROJECTS_DB_HOST $PROJECTS_DB_HOST
ENV PROJECTS_DB_PORT_EXT $PROJECTS_DB_PORT_EXT

ENV SUPERUSER_NAME $SUPERUSER_NAME
ENV SUPERUSER_EMAIL $SUPERUSER_EMAIL
ENV SUPERUSER_PASSWORD $SUPERUSER_PASSWORD
ENV DEFAULT_DOCKER_HOST $DEFAULT_DOCKER_HOST
ENV MAIN_APP_PORT $MAIN_APP_PORT

RUN python manage.py migrate
RUN python manage.py migrate --database=$USERS_DB_NAME
RUN python manage.py migrate --database=$PROJECTS_DB_NAME

RUN python manage.py createsuperuser --username $SUPERUSER_NAME --email $SUPERUSER_EMAIL --password $SUPERUSER_PASSWORD

RUN python manage.py runserver $DEFAULT_DOCKER_HOST:$MAIN_APP_PORT